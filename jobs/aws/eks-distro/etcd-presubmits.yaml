presubmits:
  aws/eks-distro:
  - name: etcd-presubmit
    always_run: false
    run_if_changed: "projects/etcd-io/etcd/.*"
    max_concurrency: 10
    cluster: "prow-jobs-cluster"
    skip_report: false
    decoration_config:
      gcs_configuration:
        bucket: s3://prowdataclusterstack-316-prowpresubmitsbucket7203-1swi49tnwncy8
        path_strategy: explicit
      s3_credentials_secret: s3-credentials
    clone_uri: "git@github.com:aws/eks-distro.git"
    labels:
      image-build: "true"
    spec:
      serviceaccountName: presubmits-build-account
      containers:
      - name: build-container
        image: 316434458148.dkr.ecr.us-west-2.amazonaws.com/eks-distro/builder:51f42f4402f38946eb23884a32a2541b8ac6edca
        command:
        - bash
        - -c
        - >
          make build -C projects/etcd-io/etcd DEVELOPMENT=false
          &&
          mv ./projects/etcd-io/etcd/_output/tar/* /logs/artifacts
          &&
          touch /status/done
        livenessProbe:
          exec:
            command:
            - bash
            - -c
            - date +%s > /status/pending
          periodSeconds: 10
      - name: buildkitd
        image: moby/buildkit:master-rootless
        command:
        - sh
        args:
        - /script/entrypoint.sh
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - test $(($(date +%s) - 15)) -lt $(cat /status/pending)
          periodSeconds: 15
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000

